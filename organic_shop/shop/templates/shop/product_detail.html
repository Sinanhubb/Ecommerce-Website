{% extends 'shop/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'shop:index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'shop:category_detail' product.category.slug %}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name|truncatechars:30 }}</li>
        </ol>
    </nav>
    <div class="row">
       
        <div class="col-md-6">
           
            <div class="main-image mb-4 border rounded p-2">
                <img id="main-product-image" src="{{ product.image.url }}" class="img-fluid w-100" alt="{{ product.name }}" 
                     style="cursor: zoom-in; max-height: 500px; object-fit: contain;">
            </div>

            <!-- Thumbnail Gallery -->
            <div class="thumbnail-gallery d-flex flex-wrap gap-2">
                <img src="{{ product.image.url }}" class="img-thumbnail thumbnail-item active" 
                     style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" 
                     onclick="changeMainImage(this)" alt="{{ product.name }}">

                {% for img in product.images.all %}
                    <img src="{{ img.image.url }}" class="img-thumbnail thumbnail-item" 
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" 
                         onclick="changeMainImage(this)" alt="Product image {{ forloop.counter }}">
                {% endfor %}
            </div>
        </div>

        
<div class="col-md-6">
    <!-- Product Header -->
    <div class="product-header mb-3">
        <h1 class="fw-bold">{{ product.name }}</h1>
        <div class="d-flex align-items-center">
            {% if average_rating %}
                <div class="rating me-3">
                    <span class="stars text-warning">
                        {% for i in "12345" %}
                            {% if forloop.counter <= average_rating|floatformat:0 %}
                                ★
                            {% else %}
                                ☆
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="ms-1">{{ average_rating|floatformat:1 }} ({{ reviews.count }} reviews)</span>
                </div>
            {% else %}
                <span class="text-muted">No ratings yet</span>
            {% endif %}
        </div>
    </div>

    <!-- Stock Status Badge -->
    <div class="mb-3">
        {% if product.has_variants %}
            <span class="badge bg-secondary" id="stock-badge">Select options to see stock</span>
        {% else %}
            {% if product.stock > 0 %}
                <span class="badge bg-success">In Stock ({{ product.stock }} available)</span>
            {% else %}
                <span class="badge bg-danger">Out of Stock</span>
            {% endif %}
        {% endif %}
    </div>

    <!-- Price Section -->
    <div class="price-section mb-4 p-3 bg-light rounded-3" id="price-display">
        <div id="price-output">
            {% if product.has_variants %}
                <div class="d-flex align-items-center">
                    <span class="fs-4 fw-semibold text-muted">Select options to see price</span>
                </div>
            {% elif product.display_price %}
                {% if product.display_discount %}
                    <div class="d-flex align-items-center flex-wrap">
                        <span class="fs-2 fw-bold text-danger me-3">₹{{ product.discount_price }}</span>
                        <span class="text-decoration-line-through text-muted me-3 fs-5">₹{{ product.price }}</span>
                        <span class="badge bg-danger fs-6 py-2">Save {{ product.display_discount }}%</span>
                    </div>
                {% else %}
                    <span class="fs-2 fw-bold">₹{{ product.price }}</span>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Product Description -->
    <div class="description mb-4">
        <h5 class="fw-bold">Description</h5>
        <p class="text-muted">{{ product.description }}</p>
    </div>

    <!-- Variant Options (Button Pills) -->
    {% if product.has_variants %}
<div id="variant-options" class="mb-4">
    {% for option, values in variant_options.items %}
    <div class="mb-3">
        <label class="fw-bold mb-2">{{ option }} <span class="text-danger">*</span></label>
        <div class="btn-group d-flex flex-wrap gap-2 variant-group" role="group" data-option="{{ option }}">
            
            {% if option|lower == 'color' %}
                {% for value in values %}
                    <button type="button" class="btn variant-btn color-swatch"
                            data-option="{{ option }}" data-value="{{ value }}"
                            style="background-color: {{ value|lower }};"
                            title="{{ value }}">
                        <span class="visually-hidden">{{ value }}</span>
                    </button>
                {% endfor %}
            {% else %}
                {% for value in values %}
                    <button type="button" class="btn variant-btn text-swatch"
                            data-option="{{ option }}" data-value="{{ value }}">
                        {{ value }}
                    </button>
                {% endfor %}
            {% endif %}

        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

    <!-- Action Buttons -->
    <div class="action-buttons mb-4">
        <div class="d-flex flex-column flex-md-row gap-3 align-items-start">
            <div class="input-group mb-2" style="width: 150px;">
                <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity()">−</button>
                {{ cart_product_form.quantity }}
                <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity()">+</button>
            </div>

            <!-- Add to Cart Form -->
            <form action="{% url 'shop:cart_add' product.id %}" method="post" class="flex-grow-1">
                {% csrf_token %}
                <input type="hidden" name="variant_id" id="cart-variant-id">
                <input type="hidden" name="quantity" id="cart-quantity-input" value="1">
                
                {% if product.has_variants %}
                    <button type="submit" id="add-to-cart-btn" class="btn btn-primary btn-lg w-100 mb-2" disabled>
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                {% else %}
                    {% if product.stock > 0 %}
                        <button type="submit" class="btn btn-primary btn-lg w-100 mb-2">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-secondary btn-lg w-100 mb-2" disabled>
                            Out of Stock
                        </button>
                    {% endif %}
                {% endif %}
            </form>

            <!-- Buy Now Form -->
            {% if product.has_variants %}
                <form id="buyNowForm" method="POST" action="{% url 'shop:buy_now' product.id %}" class="flex-grow-1">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" id="buyNowQuantity" value="1">
                    <input type="hidden" id="buy-variant-id" name="variant_id" value="">
                    <button type="submit" id="buy-now-btn" class="btn btn-success btn-lg w-100 mb-2" disabled>
                        Buy Now
                    </button>
                </form>
            {% else %}
                {% if product.stock > 0 %}
                    <form id="buyNowForm" method="POST" action="{% url 'shop:buy_now' product.id %}" class="flex-grow-1">
                        {% csrf_token %}
                        <input type="hidden" name="quantity" id="buyNowQuantity" value="1">
                        <input type="hidden" name="variant_id" value="">
                        <button type="submit" id="buy-now-btn" class="btn btn-success btn-lg w-100 mb-2">
                            Buy Now
                        </button>
                    </form>
                {% else %}
                    <button class="btn btn-secondary btn-lg w-100 mb-2" disabled>
                        Out of Stock
                    </button>
                {% endif %}
            {% endif %}
        </div>

        <!-- Wishlist + Share -->
        <div class="d-flex gap-2 mt-3">
            <form action="{% url 'accounts:add_to_wishlist' product.id %}" method="post" class="flex-grow-1 wishlist-form">
                {% csrf_token %}
                
                <input type="hidden" name="variant_id" id="wishlist-variant-id" value="{{ default_variant.id | default:'' }}">
                
                <button type="submit" class="btn btn-outline-danger btn-lg w-100">
                    <i class="bi bi-heart"></i> Wishlist
                </button>
            </form>

            <button class="btn btn-outline-dark btn-lg" onclick="toggleShareIcons()">
                <i class="bi bi-share"></i>
            </button>
        </div>

        <!-- Share Icons -->
        <div id="share-icons" class="mt-3 p-3 bg-light rounded d-none">
            <h6 class="mb-2">Share this product:</h6>
            <div class="d-flex gap-2">
                <a href="https://wa.me/?text=Check%20out%20this%20product:%20{{ product.name }}%20{{ request.build_absolute_uri }}" 
                target="_blank" class="btn btn-success">
                    <i class="bi bi-whatsapp"></i> WhatsApp
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                target="_blank" class="btn btn-primary">
                    <i class="bi bi-facebook"></i> Facebook
                </a>
                <a href="https://twitter.com/intent/tweet?text=Check%20out%20{{ product.name }}&url={{ request.build_absolute_uri }}" 
                target="_blank" class="btn btn-dark">
                    <i class="bi bi-twitter-x"></i> Twitter
                </a>
            </div>
        </div>
    </div>

    <!-- Product Highlights -->
    <div class="highlights mb-4">
        <h5 class="fw-bold">Highlights</h5>
        <ul class="list-unstyled">
            
        </ul>
    </div>
</div>       

    <!-- Similar Products -->
    <div class="similar-products mt-5 pt-4 border-top">
        <h3 class="mb-4 fw-bold">You may also like</h3>
        <div class="row">
            {% for variant in similar_variants %}
                <div class="col-6 col-md-3 mb-4">
                    <div class="card h-100 product-card">
                        {% if variant.discount_price %}
                            <span class="badge bg-danger position-absolute" style="top: 10px; right: 10px;">
                                {{ variant.get_discount_percentage }}%
                            </span>
                        {% endif %}
                        {% if variant.stock <= 0 %}
                            <div class="position-absolute w-100 h-100 bg-light bg-opacity-75 d-flex align-items-center justify-content-center">
                                <span class="badge bg-danger fs-6">Out of Stock</span>
                            </div>
                        {% endif %}
                        <img src="{% if variant.image %}{{ variant.image.url }}{% else %}{{ variant.product.image.url }}{% endif %}" 
                        class="card-img-top p-3" 
                        alt="{{ variant.product.name }}" 
                        style="height: 200px; object-fit: contain;">
                        <div class="card-body">
                            <h6 class="card-title">{{ variant.product.name|truncatechars:40 }}</h6>
                            <div class="price">
                                {% if variant.discount_price %}
                                    <span class="text-danger fw-bold">₹{{ variant.discount_price }}</span>
                                    <small class="text-decoration-line-through text-muted">₹{{ variant.price }}</small>
                                {% else %}
                                    <span class="fw-bold">₹{{ variant.price }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            {% if variant.stock > 0 %}
                                <a href="{% url 'shop:product_detail' variant.product.slug %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-sm w-100" disabled>Out of Stock</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recently Viewed -->
    <div class="recently-viewed mt-5 pt-4 border-top">
        <h3 class="mb-4 fw-bold">Recently Viewed</h3>
        <div class="row">
            {% for variant in recently_viewed_variants %}
                <div class="col-6 col-md-3 mb-4">
                    <div class="card h-100 product-card">
                        {% if variant.discount_price %}
                            <span class="badge bg-danger position-absolute" style="top: 10px; right: 10px;">
                                {{ variant.get_discount_percentage }}%
                            </span>
                        {% endif %}
                        {% if variant.stock <= 0 %}
                            <div class="position-absolute w-100 h-100 bg-light bg-opacity-75 d-flex align-items-center justify-content-center">
                                <span class="badge bg-danger fs-6">Out of Stock</span>
                            </div>
                        {% endif %}
                        <img src="{% if variant.image %}{{ variant.image.url }}{% else %}{{ variant.product.image.url }}{% endif %}" 
                        class="card-img-top p-3" 
                        alt="{{ variant.product.name }}" 
                        style="height: 200px; object-fit: contain;">
                        <div class="card-body">
                            <h6 class="card-title">{{ variant.product.name|truncatechars:40 }}</h6>
                            <div class="price">
                                {% if variant.discount_price %}
                                    <span class="text-danger fw-bold">₹{{ variant.discount_price }}</span>
                                    <small class="text-decoration-line-through text-muted">₹{{ variant.price }}</small>
                                {% else %}
                                    <span class="fw-bold">₹{{ variant.price }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            {% if variant.stock > 0 %}
                                <a href="{% url 'shop:product_detail' variant.product.slug %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-sm w-100" disabled>Out of Stock</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews mt-5 pt-4 border-top">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">Customer Reviews</h3>
            {% if user.is_authenticated %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">
                    <i class="bi bi-pencil-square"></i> Write a Review
                </button>
            {% endif %}
        </div>

        {% if reviews %}
            <!-- Rating Summary -->
            <div class="row mb-5">
                <div class="col-md-4">
                    <div class="card p-3 text-center">
                        <h2 class="display-4 fw-bold text-warning">{{ average_rating|floatformat:1 }}</h2>
                        <div class="stars mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= average_rating|floatformat:0 %}
                                    ★
                                {% else %}
                                    ☆
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-muted">{{ reviews.count }} reviews</p>
                    </div>
                </div>
                <div class="col-md-8">
                </div>
            </div>

            <!-- Reviews List -->
            <div class="review-list">
                {% for review in reviews %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <strong>{{ review.user.username }}</strong>
                                    <span class="text-warning ms-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                                        {% endfor %}
                                    </span>
                                </div>
                                <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-0">{{ review.comment }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5 bg-light rounded">
                <i class="bi bi-chat-square-text fs-1 text-muted"></i>
                <h5 class="mt-3">No reviews yet</h5>
                <p class="text-muted">Be the first to review this product</p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">
                        Login to Review
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating-input">
                            {% for i in "54321" %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" 
                                       {% if review_form.rating.value == i %}checked{% endif %} required>
                                <label for="star{{ i }}" class="star-label">★</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_comment" class="form-label">Review</label>
                        <textarea class="form-control" id="id_comment" name="comment" rows="4" required>{{ review_form.comment.value|default:'' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit Review</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function changeMainImage(thumbnail) {
        document.getElementById('main-product-image').src = thumbnail.src;
        document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
        thumbnail.classList.add('active');
    }

    function incrementQuantity() {
        const visibleQuantityInput = document.querySelector('input[id="id_quantity"]');
        const hiddenCartInput = document.getElementById('cart-quantity-input');
        const maxStock = parseInt(visibleQuantityInput.getAttribute('max')) || 999;
        let currentValue = parseInt(visibleQuantityInput.value);
        if (currentValue < maxStock) {
            visibleQuantityInput.value = currentValue + 1;
            if (hiddenCartInput) {
                hiddenCartInput.value = visibleQuantityInput.value;
            }
        }
    }

    function decrementQuantity() {
        const visibleQuantityInput = document.querySelector('input[id="id_quantity"]');
        const hiddenCartInput = document.getElementById('cart-quantity-input');
        let currentValue = parseInt(visibleQuantityInput.value);
        if (currentValue > 1) {
            visibleQuantityInput.value = currentValue - 1;
            if (hiddenCartInput) {
                hiddenCartInput.value = visibleQuantityInput.value;
            }
        }
    }

    function toggleShareIcons() {
        document.getElementById('share-icons').classList.toggle('d-none');
    }


    document.addEventListener("DOMContentLoaded", () => {
        if (!document.getElementById('variant-options')) return; 

        const variantOptionGroups = document.querySelectorAll('.btn-group[data-option]');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const buyNowBtn = document.getElementById('buy-now-btn');
        const cartVariantInput = document.getElementById('cart-variant-id');
        const buyVariantInput = document.getElementById('buy-variant-id');
        const wishlistVariantInput = document.getElementById('wishlist-variant-id');
        const priceDisplay = document.getElementById('price-display');
        const stockBadge = document.getElementById('stock-badge');
        const quantityInput = document.querySelector('input[name="quantity"]');
        const buyNowForm = document.getElementById('buyNowForm');
        
        const allVariants = JSON.parse('{{ variant_data_json|escapejs }}');
        const productId = {{ product.id }};
        const csrfToken = '{{ csrf_token }}';
        const originalPriceHTML = priceDisplay.innerHTML;
        const TOTAL_OPTIONS = variantOptionGroups.length;

        let selectedOptions = {};
        let fetchTimeout;

        function resetUIDisplays() {
            priceDisplay.innerHTML = originalPriceHTML;
            if (stockBadge) {
                stockBadge.className = 'badge bg-secondary';
                stockBadge.textContent = 'Select options to see stock';
            }
            toggleActionButtons(false);
            if (cartVariantInput) cartVariantInput.value = '';
            if (buyVariantInput) buyVariantInput.value = '';
            if (wishlistVariantInput) wishlistVariantInput.value = '';
            if (quantityInput) {
                quantityInput.value = 1;
                quantityInput.removeAttribute('max');
            }
        }

        function toggleActionButtons(enabled, inStock = false) {
            if (addToCartBtn) {
                addToCartBtn.disabled = !enabled;
                addToCartBtn.innerHTML = inStock ? '<i class="bi bi-cart-plus"></i> Add to Cart' : 'Out of Stock';
            }
            if (buyNowBtn) {
                buyNowBtn.disabled = !enabled;
                buyNowBtn.textContent = inStock ? 'Buy Now' : 'Out of Stock';
            }
        }

        function fetchVariantData() {
            if (Object.keys(selectedOptions).length !== TOTAL_OPTIONS) return;
            fetch("{% url 'shop:get_matching_variant' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify({ product_id: productId, selected_values: Object.values(selectedOptions) })
            })
            .then(response => response.ok ? response.json() : Promise.reject('Network error'))
            .then(data => { if (data.success) { updateUIData(data); } else { resetUIDisplays(); } })
            .catch(error => { console.error('Error fetching variant:', error); resetUIDisplays(); });
        }

        function updateUIData(data) {
            if (stockBadge) {
                stockBadge.className = data.stock > 0 ? 'badge bg-success' : 'badge bg-danger';
                stockBadge.textContent = data.stock > 0 ? `In Stock (${data.stock} available)` : 'Out of Stock';
            }
            if (quantityInput) {
                quantityInput.setAttribute('max', data.stock);
                if (parseInt(quantityInput.value) > data.stock || data.stock === 0) {
                    quantityInput.value = data.stock > 0 ? 1 : 1;
                }
            }
            const discountPercent = data.discount_price ? Math.round((1 - data.discount_price / data.price) * 100) : 0;
            let priceHTML = '';
            if (data.discount_price) {
                priceHTML = `<div class="d-flex align-items-center flex-wrap"><span class="fs-2 fw-bold text-danger me-3">₹${parseFloat(data.discount_price).toFixed(2)}</span><span class="text-decoration-line-through text-muted me-3 fs-5">₹${parseFloat(data.price).toFixed(2)}</span>${discountPercent > 0 ? `<span class="badge bg-danger fs-6 py-2">Save ${discountPercent}%</span>` : ''}</div>`;
            } else {
                priceHTML = `<span class="fs-2 fw-bold">₹${parseFloat(data.price).toFixed(2)}</span>`;
            }
            priceDisplay.innerHTML = priceHTML;
            if (data.image) { document.getElementById('main-product-image').src = data.image; }
            const variantId = data.variant_id || '';
            if (cartVariantInput) cartVariantInput.value = variantId;
            if (buyVariantInput) buyVariantInput.value = variantId;
            if (wishlistVariantInput) wishlistVariantInput.value = variantId;
            toggleActionButtons(data.stock > 0, data.stock > 0);
        }
        
        function updateVariantAvailability() {
            variantOptionGroups.forEach((group, index) => {
                group.querySelectorAll('.variant-btn').forEach(btn => {
                    const btnValue = btn.dataset.value;
                    let tempSelection = {};
                    for (let i = 0; i < index; i++) {
                        const prevOptionName = variantOptionGroups[i].dataset.option;
                        if(selectedOptions[prevOptionName]) { tempSelection[prevOptionName] = selectedOptions[prevOptionName]; }
                    }
                    tempSelection[group.dataset.option] = btnValue;
                    const tempValues = Object.values(tempSelection);
                    const isPossible = allVariants.some(variant => tempValues.every(val => variant.values.includes(val.toLowerCase())));
                    btn.disabled = !isPossible;
                    btn.classList.toggle('disabled', !isPossible);
                });
            });
        }

        function handleVariantClick(event) {
            const clickedBtn = event.currentTarget;
            if (clickedBtn.disabled) return;
            const optionName = clickedBtn.dataset.option;
            const isAlreadyActive = clickedBtn.classList.contains('active');
            clickedBtn.closest('.btn-group').querySelectorAll('.variant-btn').forEach(sibling => sibling.classList.remove('active'));
            if (!isAlreadyActive) {
                clickedBtn.classList.add('active');
                selectedOptions[optionName] = clickedBtn.dataset.value;
            } else {
                delete selectedOptions[optionName];
            }
            const clickedOptionIndex = Array.from(variantOptionGroups).findIndex(g => g.dataset.option === optionName);
            for (let i = clickedOptionIndex + 1; i < TOTAL_OPTIONS; i++) {
                const groupToClear = variantOptionGroups[i];
                delete selectedOptions[groupToClear.dataset.option];
                groupToClear.querySelectorAll('.variant-btn').forEach(btn => btn.classList.remove('active'));
            }
            updateVariantAvailability();
            if (Object.keys(selectedOptions).length === TOTAL_OPTIONS) {
                clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(fetchVariantData, 200);
            } else {
                resetUIDisplays();
            }
        }

        
        document.querySelectorAll('.variant-btn').forEach(btn => btn.addEventListener('click', handleVariantClick));
        
        if (buyNowForm) {
            buyNowForm.addEventListener('submit', function (e) {
                const buyNowQuantity = document.getElementById('buyNowQuantity');
                if (quantityInput && buyNowQuantity) { buyNowQuantity.value = quantityInput.value; }
            });
        }
        
        
        const defaultVariantValues = [{% for value in default_variant.values.all %}"{{ value.value }}",{% endfor %}];
        if (defaultVariantValues.length > 0) {
            defaultVariantValues.forEach(val => {
                const btn = document.querySelector(`.variant-btn[data-value="${val}"]`);
                if (btn) btn.click();
            });
        } else {
            updateVariantAvailability();
        }
    });
</script>




<style>

.action-buttons .btn-lg {
    padding: 0.6rem 1rem; 
    border-radius: 8px;
    border: none;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.action-buttons .btn-lg:hover:not(:disabled) {
    transform: translateY(-2px); 
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.action-buttons .btn-lg:active:not(:disabled) {
    transform: translateY(0); 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.thumbnail-item.active {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}


.variant-btn {
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    min-width: 50px;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease-in-out;
    position: relative;
    background-color: #fff;
    color: #333;
}

.variant-btn:hover {
    border-color: #999;
}

.variant-btn.active {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    color: #0d6efd;
    font-weight: bold;
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
}

.color-swatch {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    border-width: 3px;
    border-color: #fff;
    box-shadow: 0 0 0 1px #e0e0e0;
}

.color-swatch.active::after {
    content: '✔';
    color: white;
    text-shadow: 0px 0px 3px rgba(0, 0, 0, 0.7);
    font-size: 1.2rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.variant-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    background-color: #f8f9fa;
    border-color: #e0e0e0;
    box-shadow: none;
    position: relative; 
}

.variant-btn.disabled::before {
    content: '';
    position: absolute;
    top: 50%;
    left: -5%;
    width: 110%;
    height: 1.5px;
    background-color: #999;
    transform: rotate(-15deg);
}

.color-swatch.disabled::before {
    transform: rotate(45deg); 

}
.rating-input { display: flex; direction: rtl; unicode-bidi: bidi-override; }
.rating-input input { display: none; }
.rating-input label { font-size: 2rem; color: #ddd; cursor: pointer; }
.rating-input input:checked ~ label, .rating-input label:hover, .rating-input label:hover ~ label { color: #ffc107; }
.product-card:hover { transform: translateY(-5px); transition: transform 0.3s ease; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
.star-label { cursor: pointer; font-size: 1.5rem; color: #ddd; }
.star-label:hover, .star-label:hover ~ .star-label, input[type="radio"]:checked ~ .star-label { color: #ffc107; }
</style>

{% endblock %}