{% extends 'shop/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Product Images Column -->
        <div class="col-md-6">
            <!-- Main Image with Zoom Effect -->
            <div class="main-image mb-4 border rounded p-2">
                <img id="main-product-image" src="{{ product.image.url }}" class="img-fluid w-100" alt="{{ product.name }}" 
                     style="cursor: zoom-in; max-height: 500px; object-fit: contain;">
            </div>

            <!-- Thumbnail Gallery -->
            <div class="thumbnail-gallery d-flex flex-wrap gap-2">
                <img src="{{ product.image.url }}" class="img-thumbnail thumbnail-item active" 
                     style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" 
                     onclick="changeMainImage(this)" alt="{{ product.name }}">

                {% for img in product.images.all %}
                    <img src="{{ img.image.url }}" class="img-thumbnail thumbnail-item" 
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" 
                         onclick="changeMainImage(this)" alt="Product image {{ forloop.counter }}">
                {% endfor %}
            </div>
        </div>

        <!-- Product Info Column -->
        <div class="col-md-6">
            <!-- Product Header -->
            <div class="product-header mb-3">
                <h1 class="fw-bold">{{ product.name }}</h1>
                <div class="d-flex align-items-center">
                    {% if average_rating %}
                        <div class="rating me-3">
                            <span class="stars text-warning">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= average_rating|floatformat:0 %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <span class="ms-1">{{ average_rating|floatformat:1 }} ({{ reviews.count }} reviews)</span>
                        </div>
                    {% else %}
                        <span class="text-muted">No ratings yet</span>
                    {% endif %}
                    <span class="ms-3 text-success">
                        <i class="bi bi-check-circle-fill"></i> 
                        {% if product.stock > 10 %}
                            In Stock
                        {% elif product.stock > 0 %}
                            Only {{ product.stock }} left!
                        {% else %}
                            Out of Stock
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Price Section -->
            <div class="price-section mb-4 p-3 bg-light rounded" id="price-display">
                {% if product.discount_price %}
                    <div class="d-flex align-items-center">
                        <span class="fs-3 fw-bold text-danger me-3">₹{{ product.discount_price }}</span>
                        <span class="text-decoration-line-through text-muted me-3">₹{{ product.price }}</span>
                        <span class="badge bg-danger fs-6">Save {{ product.get_discount_percentage }}%</span>
                    </div>
                {% else %}
                    <span class="fs-3 fw-bold">₹{{ product.price }}</span>
                {% endif %}
            </div>


            <!-- Product Description -->
            <div class="description mb-4">
                <h5 class="fw-bold">Description</h5>
                <p class="text-muted">{{ product.description }}</p>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons mb-4">
                <form action="{% url 'shop:cart_add' product.id %}" method="post" class="d-inline-block me-2">
                    

                    {% csrf_token %}
                    <input type="hidden" name="variant_id" id="cart-variant-id">
                    <div class="input-group mb-2" style="width: 150px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity()">−</button>
                        {{ cart_product_form.quantity }}
                        <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity()">+</button>
                    </div>

                    {% if product.stock > 0 %}
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-secondary btn-lg w-100" disabled>
                            Out of Stock
                        </button>
                    {% endif %}
                </form>
                <!-- Variant Options (Button Pills) -->
                    <div id="variant-options">
                    {% for option, values in variant_options.items %}
                        <div class="mb-3">
                        <label class="fw-bold">{{ option }}</label>
                        <div class="btn-group d-flex flex-wrap" role="group" data-option="{{ option }}">
                            {% for value in values %}
                            <button type="button" class="btn btn-outline-secondary variant-btn m-1"
                                    data-option="{{ option }}" data-value="{{ value }}">
                                {{ value }}
                            </button>
                            {% endfor %}
                        </div>
                        </div>
                    {% endfor %}
                    </div>

                    <!-- Variant result area -->
                    <div id="variant-info" class="mt-3 p-3 bg-light rounded text-muted">
                    <em>Select variant options to see price and stock.</em>
                    </div>


                <!-- Buy Now Form -->
                {% if product.stock > 0 %}
                <form id="buyNowForm" action="{% url 'accounts:direct_checkout' product.id %}" method="POST" class="mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" id="buyNowQuantity" value="1">
                    <input type="hidden" name="variant_id" id="buy-variant-id">
                    <button type="submit" class="btn btn-success w-100 btn-lg">Buy Now</button>
                </form>
                {% endif %}

                <!-- Wishlist + Share -->
                <div class="d-flex gap-2 mt-2">
                    <form action="{% url 'accounts:add_to_wishlist' product.id %}" method="post" class="flex-grow-1">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-lg w-100">
                            <i class="bi bi-heart"></i> Wishlist
                        </button>
                    </form>

                    <button class="btn btn-outline-dark btn-lg" onclick="toggleShareIcons()">
                        <i class="bi bi-share"></i>
                    </button>
                </div>

                <!-- Share Icons -->
                <div id="share-icons" class="mt-3 p-3 bg-light rounded d-none">
                    <h6 class="mb-2">Share this product:</h6>
                    <div class="d-flex gap-2">
                        <a href="https://wa.me/?text=Check%20out%20this%20product:%20{{ product.name }}%20{{ request.build_absolute_uri }}" 
                        target="_blank" class="btn btn-success">
                            <i class="bi bi-whatsapp"></i> WhatsApp
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                        target="_blank" class="btn btn-primary">
                            <i class="bi bi-facebook"></i> Facebook
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=Check%20out%20{{ product.name }}&url={{ request.build_absolute_uri }}" 
                        target="_blank" class="btn btn-dark">
                            <i class="bi bi-twitter-x"></i> Twitter
                        </a>
                    </div>
                </div>
            </div>

            <!-- Product Highlights -->
            <div class="highlights mb-4">
                <h5 class="fw-bold">Highlights</h5>
                <ul class="list-unstyled">
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i> Free shipping on orders over ₹500</li>
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i> 7-day easy returns</li>
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i> 1-year warranty</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="similar-products mt-5 pt-4 border-top">
        <h3 class="mb-4 fw-bold">You may also like</h3>
        <div class="row">
            {% for similar in similar_products %}
            <div class="col-6 col-md-3 mb-4">
                <div class="card h-100 product-card">
                    {% if similar.discount_price %}
                    <span class="badge bg-danger position-absolute" style="top: 10px; right: 10px;">
                        -{{ similar.get_discount_percentage }}%
                    </span>
                    {% endif %}
                    <img src="{{ similar.image.url }}" class="card-img-top p-3" alt="{{ similar.name }}" style="height: 200px; object-fit: contain;">
                    <div class="card-body">
                        <h6 class="card-title">{{ similar.name|truncatechars:40 }}</h6>
                        <div class="price">
                            {% if similar.discount_price %}
                            <span class="text-danger fw-bold">₹{{ similar.discount_price }}</span>
                            <small class="text-decoration-line-through text-muted">₹{{ similar.price }}</small>
                            {% else %}
                            <span class="fw-bold">₹{{ similar.price }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="{% url 'shop:product_detail' similar.slug %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recently Viewed -->
    <div class="recently-viewed mt-5 pt-4 border-top">
        <h3 class="mb-4 fw-bold">Recently Viewed</h3>
        <div class="row">
            {% for p in recently_viewed %}
            <div class="col-6 col-md-3 mb-4">
                <div class="card h-100 product-card">
                    {% if p.discount_price %}
                    <span class="badge bg-danger position-absolute" style="top: 10px; right: 10px;">
                        -{{ p.get_discount_percentage }}%
                    </span>
                    {% endif %}
                    <img src="{{ p.image.url }}" class="card-img-top p-3" alt="{{ p.name }}" style="height: 200px; object-fit: contain;">
                    <div class="card-body">
                        <h6 class="card-title">{{ p.name|truncatechars:40 }}</h6>
                        <div class="price">
                            {% if p.discount_price %}
                            <span class="text-danger fw-bold">₹{{ p.discount_price }}</span>
                            <small class="text-decoration-line-through text-muted">₹{{ p.price }}</small>
                            {% else %}
                            <span class="fw-bold">₹{{ p.price }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <a href="{% url 'shop:product_detail' p.slug %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews mt-5 pt-4 border-top">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">Customer Reviews</h3>
            {% if user.is_authenticated %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">
                    <i class="bi bi-pencil-square"></i> Write a Review
                </button>
            {% endif %}
        </div>

        {% if reviews %}
            <!-- Rating Summary -->
            <div class="row mb-5">
                <div class="col-md-4">
                    <div class="card p-3 text-center">
                        <h2 class="display-4 fw-bold text-warning">{{ average_rating|floatformat:1 }}</h2>
                        <div class="stars mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= average_rating|floatformat:0 %}
                                    ★
                                {% else %}
                                    ☆
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-muted">{{ reviews.count }} reviews</p>
                    </div>
                </div>
                <div class="col-md-8">
                    <!-- Rating distribution could go here -->
                </div>
            </div>

            <!-- Reviews List -->
            <div class="review-list">
                {% for review in reviews %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <strong>{{ review.user.username }}</strong>
                                    <span class="text-warning ms-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                                        {% endfor %}
                                    </span>
                                </div>
                                <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-0">{{ review.comment }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5 bg-light rounded">
                <i class="bi bi-chat-square-text fs-1 text-muted"></i>
                <h5 class="mt-3">No reviews yet</h5>
                <p class="text-muted">Be the first to review this product</p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">
                        Login to Review
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating-input">
                            {% for i in "54321" %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" 
                                       {% if review_form.rating.value == i %}checked{% endif %} required>
                                <label for="star{{ i }}" class="star-label">★</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_comment" class="form-label">Review</label>
                        <textarea class="form-control" id="id_comment" name="comment" rows="4" required>{{ review_form.comment.value|default:'' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit Review</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const selectedVariants = {};
const addToCartBtn = document.querySelector('form[action*="cart_add"] button[type="submit"]');
const buyNowBtn = document.querySelector('#buyNowForm button[type="submit"]');
const cartVariantInput = document.getElementById('cart-variant-id');
const buyVariantInput = document.getElementById('buy-variant-id');
const priceDisplay = document.getElementById('price-display');

function toggleButtons(enabled) {
    if (addToCartBtn) addToCartBtn.disabled = !enabled;
    if (buyNowBtn) buyNowBtn.disabled = !enabled;
}

// Disable buttons initially
toggleButtons(false);

// Change main image when thumbnail clicked
function changeMainImage(element) {
    const mainImg = document.getElementById('main-product-image');
    mainImg.src = element.src;
    document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
    element.classList.add('active');
}

// Zoom toggle
document.getElementById('main-product-image').addEventListener('click', function () {
    this.classList.toggle('zoomed');
    this.style.transition = 'transform 0.3s ease';
});

// Toggle share icons
function toggleShareIcons() {
    const shareIcons = document.getElementById("share-icons");
    shareIcons.classList.toggle("d-none");
}

// Variant selection buttons
document.querySelectorAll('.variant-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const option = btn.dataset.option;
        const value = btn.dataset.value;

        document.querySelectorAll(`.variant-btn[data-option="${option}"]`).forEach(b => {
            b.classList.remove('active', 'btn-primary');
            b.classList.add('btn-outline-secondary');
        });

        btn.classList.add('active', 'btn-primary');
        btn.classList.remove('btn-outline-secondary');

        selectedVariants[option] = value;

        const totalOptions = document.querySelectorAll('.btn-group[data-option]').length;

        const infoDiv = document.getElementById('variant-info');
        if (Object.keys(selectedVariants).length === totalOptions) {
            infoDiv.innerHTML = `<em>Loading variant info...</em>`;
            fetchVariantData();
        } else {
            toggleButtons(false);
            if (cartVariantInput) cartVariantInput.value = '';
            if (buyVariantInput) buyVariantInput.value = '';
            infoDiv.innerHTML = `<em>Select variant options to see price and stock.</em>`;
        }
    });
});

// Fetch variant info via AJAX
function fetchVariantData() {
    fetch("{% url 'shop:get_matching_variant' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            selected_values: Object.values(selectedVariants)
        })
    })
    .then(response => response.json())
    .then(data => {
        const infoDiv = document.getElementById('variant-info');

        if (data.success) {
            infoDiv.innerHTML = `
                <strong>Price:</strong> ₹${data.price}<br/>
                <strong>Stock:</strong> ${data.stock}<br/>
                <strong>SKU:</strong> ${data.sku}<br/>
                ${data.image ? `<img src="${data.image}" width="150"/>` : ''}
            `;

            // Set correct variant ID
            if (cartVariantInput) cartVariantInput.value = data.sku || '';
            if (buyVariantInput) buyVariantInput.value = data.sku || '';

            // Update price display
            if (data.original_price && data.original_price > data.price) {
                priceDisplay.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="fs-3 fw-bold text-danger me-3">₹${data.price}</span>
                        <span class="text-decoration-line-through text-muted me-3">₹${data.original_price}</span>
                        <span class="badge bg-danger">Save ${data.discount_percent}%</span>
                    </div>
                `;
            } else {
                priceDisplay.innerHTML = `
                    <span class="fs-3 fw-bold">₹${data.price}</span>
                `;
            }

            // Optional: update main image if variant has specific image
            if (data.image) {
                const mainImg = document.getElementById('main-product-image');
                mainImg.src = data.image;
            }

            toggleButtons(true);
        } else {
            infoDiv.innerHTML = `<em>${data.message || "Variant not found."}</em>`;
            toggleButtons(false);
            if (cartVariantInput) cartVariantInput.value = '';
            if (buyVariantInput) buyVariantInput.value = '';
        }
    });
}

// Quantity increment/decrement
function incrementQuantity() {
    const quantityInput = document.querySelector('input[name="quantity"]');
    const stock = {{ product.stock }};
    let newQuantity = parseInt(quantityInput.value) + 1;
    if (newQuantity > stock) {
        alert(`Only ${stock} available in stock!`);
        return;
    }
    quantityInput.value = newQuantity;
}

function decrementQuantity() {
    const quantityInput = document.querySelector('input[name="quantity"]');
    if (parseInt(quantityInput.value) > 1) {
        quantityInput.value = parseInt(quantityInput.value) - 1;
    }
}

// Buy Now submit logic
document.getElementById('buyNowForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const quantityInput = document.querySelector('input[name="quantity"]');
    const buyNowQuantity = document.getElementById('buyNowQuantity');
    const stock = {{ product.stock }};

    let quantity = 1;
    if (quantityInput) {
        quantity = parseInt(quantityInput.value) || 1;
        if (quantity > stock) {
            alert(`Only ${stock} available in stock!`);
            return;
        }
    }

    buyNowQuantity.value = quantity;
    this.submit();
});
</script>

<style>
/* Variant button highlight */
.variant-btn.active {
    border-color: #0d6efd;
    background-color: #0d6efd;
    color: #fff;
}

/* Thumbnail selection */
.thumbnail-item.active {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Zoomed image */
#main-product-image.zoomed {
    transform: scale(1.5);
    cursor: zoom-out;
}

/* Rating stars */
.rating-input {
    display: flex;
    direction: rtl;
    unicode-bidi: bidi-override;
}
.rating-input input {
    display: none;
}
.rating-input label {
    font-size: 2rem;
    color: #ddd;
    cursor: pointer;
}
.rating-input input:checked ~ label,
.rating-input label:hover,
.rating-input label:hover ~ label {
    color: #ffc107;
}

/* Card hover effect */
.product-card:hover {
    transform: translateY(-5px);
    transition: transform 0.3s ease;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Review modal stars */
.star-label {
    cursor: pointer;
    font-size: 1.5rem;
    color: #ddd;
}
.star-label:hover,
.star-label:hover ~ .star-label,
input[type="radio"]:checked ~ .star-label {
    color: #ffc107;
}
</style>


{% endblock %}